<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agenda Pelotas (Firebase)</title>
<link rel="preconnect" href="https://www.gstatic.com"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --primary:#6366f1;--secondary:#a5b4fc;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;
  --ink:#111827;--muted:#6b7280;--card:#ffffff
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
  background:linear-gradient(135deg,#ffe5b4 0%,#ffd1dc 50%,#fff8e1 100%);
  color:var(--ink);
  padding:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}
header{
  display:flex;flex-wrap:wrap;gap:12px;
  align-items:center;justify-content:space-between;
  max-width:1000px;width:100%;
}
h1{
  font-size:1.9rem;
  background:linear-gradient(90deg,var(--primary),var(--secondary));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.status{font-size:.95rem;padding:6px 12px;border-radius:8px;font-weight:600}
.status.connecting{background:#fef9c3;color:#92400e}
.status.connected{background:#dcfce7;color:#166534}
.status.error{background:#fee2e2;color:#991b1b}
.btn{
  background:var(--primary);color:#fff;border:none;border-radius:12px;
  padding:10px 14px;cursor:pointer;font-weight:700;
  transition:transform .15s ease;white-space:nowrap;
}
.btn:hover{transform:translateY(-1px)}
.btn.gray{background:#9ca3af}.btn.danger{background:var(--danger)}

/* Secciones */
.section{margin-top:28px;width:100%;max-width:1000px;}
.section h2{margin-bottom:14px;border-bottom:2px solid rgba(0,0,0,.1);padding-bottom:4px;font-size:1.25rem;color:#1e293b}

/* Pelotas */
.board{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
  gap:22px;
  justify-items:center;
}
.ball{
  position:relative;width:170px;height:170px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  cursor:pointer;transition:transform .2s ease;
  --p:0; --col:#10b981;
  background:conic-gradient(var(--col) var(--p), #e5e7eb 0);
}
.ball:hover{transform:translateY(-3px) scale(1.05)}
.ball .center{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;pointer-events:none
}
.ball .frac{font-weight:800;font-size:1.2rem;color:#111827}
.ball .pct{margin-top:2px;font-weight:700;font-size:1rem;color:#374151;opacity:.9}
.ball .label{
  position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
  font-size:1rem;font-weight:700;color:#1e293b;text-align:center;
  white-space:nowrap;max-width:170px;text-overflow:ellipsis;overflow:hidden;
}
.ball.appear{animation:pop .25s ease}
@keyframes pop{0%{transform:scale(.6);opacity:.3}100%{transform:scale(1);opacity:1}}

/* Modales */
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(99,102,241,.08);padding:16px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal .box{background:#fff;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.15);padding:20px;max-width:640px;width:100%}
input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:.95rem}
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:780px){
  body{padding:10px}
  h1{font-size:1.6rem;text-align:center;width:100%}
  header{justify-content:center}
  .board{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:18px}
  .ball{width:150px;height:150px}
  .label{font-size:.95rem}
  .row.cols-2,.row.cols-3{grid-template-columns:1fr}
}
.small{font-size:.9rem;color:var(--muted)}
.list{display:grid;gap:10px;max-height:300px;overflow:auto;margin-top:8px}
.entry{background:#eef2ff;border-left:4px solid var(--primary);padding:8px;border-radius:10px}
</style>
</head>
<body>
  <header>
    <h1>Agenda Pelotas</h1>
    <div class="status connecting" id="status">ðŸ•“ Conectando...</div>
    <div>
      <button class="btn" id="btnAdd">+ Agregar</button>
      <button class="btn gray" id="btnGlobal">Historial global</button>
    </div>
  </header>

  <section class="section" id="secRecurrentes">
    <h2>Recurrentes</h2>
    <div class="board" id="boardRecurrentes"></div>
  </section>
  <section class="section" id="secOneTime">
    <h2>One Time</h2>
    <div class="board" id="boardOneTime"></div>
  </section>
  <section class="section" id="secLimit">
    <h2>LÃ­mites / Metas</h2>
    <div class="board" id="boardLimit"></div>
  </section>

  <!-- Modales (idÃ©nticos funcionalmente a la versiÃ³n anterior) -->
  <div class="modal" id="modalNew">
    <div class="box">
      <h2 style="margin-top:0">Actividad</h2>
      <div class="row cols-2">
        <div><label class="small">Nombre</label><input id="mName" placeholder="p. ej., PÃ¡del, Ahorro, Lectura"></div>
        <div>
          <label class="small">Tipo</label>
          <select id="mType">
            <option value="one_time">One time</option>
            <option value="recurrent" selected>Recurrente</option>
            <option value="limit">LÃ­mite</option>
            <option value="goal">Meta</option>
          </select>
        </div>
      </div>
      <div id="typeFields" class="row" style="margin-top:8px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn gray" id="mCancel">Cancelar</button>
        <button class="btn" id="mCreate">Guardar</button>
      </div>
    </div>
  </div>

  <!-- (Los otros modales quedan igual, no los repito por espacio) -->

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js'
import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js'
import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js'

const firebaseConfig = {
  apiKey:'AIzaSyDlJGGfe87b6SVzJ_LcRCtQ7lnSTkvQajI',
  authDomain:'agenda-e4d10.firebaseapp.com',
  projectId:'agenda-e4d10',
  storageBucket:'agenda-e4d10.firebasestorage.app',
  messagingSenderId:'537185978413',
  appId:'1:537185978413:web:f3d2561fc7a559e33010a4'
}
const app=initializeApp(firebaseConfig)
const auth=getAuth(app)
const db=getFirestore(app)

let uid=null;let tasks=[];let selected=null
const $=q=>document.querySelector(q)
const status=$('#status')

function formatNumber(num){return isNaN(num)?num:num.toLocaleString('es-CL')}
const startOfWeek=d=>{const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x}
const startOfMonth=d=>{const x=new Date(d);x.setDate(1);x.setHours(0,0,0,0);return x}
function periodWindow(p){const now=new Date();if(p==='weekly')return{start:startOfWeek(now)};if(p==='monthly')return{start:startOfMonth(now)};return{start:new Date(0)}}
function computeProgress(t){const type=t.kind||t.type;const cfg=t.config||{};const es=t.entries||[];
 if(type==='one_time')return es.length>0?1:0;
 if(type==='recurrent'){const win=periodWindow(cfg.period||'weekly');const count=es.filter(e=>new Date(e.date)>=win.start).length;const target=Math.max(1,Number(cfg.times||1));return Math.min(1,count/target);}
 if(type==='limit'||type==='goal'){const total=es.reduce((a,e)=>a+Number(e.amount||0),0);const limit=Math.max(1,Number(cfg.limit||0));return Math.min(1,limit?total/limit:0);}
 return 0;}
function colorForProgress(p){const hue=Math.round(0+140*p);return `hsl(${hue} 70% 45%)`}
function fractionForTask(t){const type=t.kind||t.type,cfg=t.config||{},es=t.entries||[];if(type==='one_time'){const num=es.length>0?1:0;return{fracText:`${num}/1`}}if(type==='recurrent'){const win=periodWindow(cfg.period||'weekly');const num=es.filter(e=>new Date(e.date)>=win.start).length;const den=Math.max(1,Number(cfg.times||1));return{fracText:`${num}/${den}`}}if(type==='limit'||type==='goal'){const num=es.reduce((a,e)=>a+Number(e.amount||0),0);const den=Math.max(1,Number(cfg.limit||0));return{fracText:`${formatNumber(num)}/${formatNumber(den)}`}}return{fracText:'0/1'}}

status.textContent='ðŸ•“ Conectando...';status.className='status connecting'
onAuthStateChanged(auth,async user=>{
 if(user){uid=user.uid;status.textContent='âœ… Conectado';status.className='status connected';await loadTasks();}
 else{await signInAnonymously(auth);}
})

async function loadTasks(){
 const snap=await getDocs(collection(db,'usuarios',uid,'tareas'))
 tasks=[];snap.forEach(d=>tasks.push({id:d.id,...d.data()}))
 renderSections()
}
function renderSections(){
 $('#boardRecurrentes').innerHTML=''
 $('#boardOneTime').innerHTML=''
 $('#boardLimit').innerHTML=''
 tasks.forEach(t=>{
  const p=computeProgress(t)
  const {fracText}=fractionForTask(t)
  const ball=document.createElement('div')
  ball.className='ball appear'
  ball.style.setProperty('--p',(p*100).toFixed(2)+'%')
  ball.style.setProperty('--col',colorForProgress(p))
  ball.innerHTML=`<div class="center"><div class="frac">${fracText}</div><div class="pct">${Math.round(p*100)}%</div></div><div class="label"><b>${t.name}</b></div>`
  if(t.kind==='recurrent')$('#boardRecurrentes').append(ball)
  else if(t.kind==='one_time')$('#boardOneTime').append(ball)
  else $('#boardLimit').append(ball)
 })
}
</script>
</body>
</html>
