<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agenda Interactiva con Firebase</title>
<style>
  body { font-family: system-ui, Arial; background:#f5f7ff; padding:24px; }
  .box { max-width:640px; margin:auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
  input, button { padding:10px; border-radius:10px; border:1px solid #cbd5e1; }
  button { background:#6366f1; color:white; border:none; cursor:pointer; }
  ul { list-style:none; padding:0; }
  li { background:#f8fafc; margin:8px 0; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;}
  .muted { color:#64748b; font-size:12px; }
  .log { background:#0b1020; color:#e2e8f0; padding:8px; border-radius:8px; font-family:ui-monospace,Consolas,monospace; max-height:140px; overflow:auto; margin-top:12px; }
</style>
</head>
<body>
<div class="box">
  <h1>🔥 Agenda con Firebase</h1>
  <p class="muted">
    Este demo usa <b>Firestore + Auth anónimo</b>.<br>
    Las tareas se guardan por usuario/dispositivo.
  </p>

  <div style="display:flex; gap:8px; margin-bottom:10px;">
    <input id="taskInput" placeholder="Nueva tarea..." />
    <button id="addBtn">Agregar</button>
  </div>

  <ul id="list"></ul>

  <h3>Logs</h3>
  <div class="log" id="log"></div>
</div>

<!-- Script principal -->
<script type="module">
  // 🔹 Importamos los SDKs Firebase (versión modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // 🔧 Tu configuración personalizada:
  const firebaseConfig = {
    apiKey: "AIzaSyDlJGGfe87b6SVzJ_LcRCtQ7lnSTkvQajI",
    authDomain: "agenda-e4d10.firebaseapp.com",
    projectId: "agenda-e4d10",
    storageBucket: "agenda-e4d10.firebasestorage.app",
    messagingSenderId: "537185978413",
    appId: "1:537185978413:web:f3d2561fc7a559e33010a4",
    measurementId: "G-R3R4S8JK23"
  };

  // 🔥 Inicializamos Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 🔸 Utilidades rápidas
  const $ = (q)=>document.querySelector(q);
  function log(...args){ const el=$("#log"); el.textContent += args.join(" ") + "\n"; el.scrollTop = el.scrollHeight; }

  // 🔑 Estado del usuario
  let uid = null;

  // ----------------------------
  // AUTENTICACIÓN ANÓNIMA
  // ----------------------------
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      uid = user.uid;
      log("✅ Conectado como:", uid);
      await listar();
    } else {
      log("🕓 Iniciando sesión anónima...");
      await signInAnonymously(auth).catch(e => log("❌ Error auth:", e.code, e.message));
    }
  });

  // ----------------------------
  // AGREGAR NUEVA TAREA
  // ----------------------------
  async function agregar() {
    const input = $("#taskInput");
    const nombre = input.value.trim();
    if (!nombre) return;
    try {
      const ref = collection(db, "usuarios", uid, "tareas");
      await addDoc(ref, { nombre, createdAt: serverTimestamp() });
      log("➕ Agregada:", nombre);
      input.value = "";
      await listar();
    } catch(e) {
      log("❌ addDoc:", e.code || e.message, e);
      alert("Error al guardar, revisa las reglas de Firestore.");
    }
  }

  // ----------------------------
  // LISTAR TAREAS
  // ----------------------------
  async function listar() {
    try {
      const ref = collection(db, "usuarios", uid, "tareas");
      const q = query(ref, orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      const ul = $("#list");
      ul.innerHTML = "";
      snap.forEach(d => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${d.data().nombre || "(sin nombre)"}</span>
                        <button data-id="${d.id}" style="background:#ef4444">Eliminar</button>`;
        li.querySelector("button").onclick = async () => {
          await deleteDoc(doc(db, "usuarios", uid, "tareas", d.id));
          log("🗑️ Eliminada:", d.id);
          await listar();
        };
        ul.appendChild(li);
      });
      log("📥 Cargadas:", snap.size, "tareas");
    } catch(e) {
      log("❌ getDocs:", e.code || e.message, e);
    }
  }

  // ----------------------------
  // EVENTOS
  // ----------------------------
  $("#addBtn").onclick = agregar;
  $("#taskInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") agregar(); });
</script>
</body>
</html>
