<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agenda Pelotas (Local)</title>
<link rel="preconnect" href="https://www.gstatic.com"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --primary:#3b82f6;--secondary:#06b6d4;--ok:#10b981;--warn:#facc15;--danger:#ef4444;
  --ink:#0f172a;--muted:#64748b;--card:#ffffff
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
  color:var(--ink);
  padding:24px;
  display:flex;flex-direction:column;align-items:center;
  min-height:100vh;
  background:linear-gradient(135deg,#b3e5fc,#a7f3d0,#dbeafe,#a5f3fc);
  background-size:400% 400%;
  animation:gradientMove 25s ease infinite;
}
@keyframes gradientMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

header{
  display:flex;gap:12px;align-items:center;justify-content:space-between;
  max-width:1000px;width:100%;flex-wrap:wrap;color:white
}
h1{
  font-size:1.8rem;margin:0;
  background:linear-gradient(90deg,var(--primary),var(--secondary));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.status{font-size:.95rem;padding:6px 12px;border-radius:8px;font-weight:600}
.status.connecting{background:#fef9c3;color:#92400e}
.status.connected{background:#dcfce7;color:#166534}
.status.error{background:#fee2e2;color:#991b1b}
.btn{
  background:var(--primary);color:#fff;border:none;border-radius:12px;
  padding:10px 14px;cursor:pointer;font-weight:700;
  transition:transform .15s ease;white-space:nowrap;
}
.btn:hover{transform:translateY(-1px)}
.btn.gray{background:#94a3b8}.btn.danger{background:var(--danger)}

/* === Secciones === */
.section{
  margin-top:28px;width:100%;max-width:1000px;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(10px);
  border-radius:16px;padding:16px 20px;box-shadow:0 6px 20px rgba(0,0,0,.1)
}
.section h2{
  font-size:1.25rem;margin-bottom:14px;border-bottom:2px solid rgba(0,0,0,.1);
  padding-bottom:4px;color:#1e3a8a
}
.board{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:22px;justify-items:center;
}

/* === Pelotas === */
.ball{
  position:relative;width:160px;height:160px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  cursor:pointer;transition:transform .2s ease;
  --p:0; --col:#10b981;
  background:conic-gradient(var(--col) var(--p), #e5e7eb 0);
}
.ball:hover{transform:translateY(-3px) scale(1.05)}
.ball .center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
.ball .frac{font-weight:800;font-size:1.2rem;color:#111827}
.ball .pct{margin-top:2px;font-weight:700;font-size:1rem;color:#374151;opacity:.9}
.ball .label{
  position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
  font-size:1rem;font-weight:700;color:#1e293b;text-align:center;
  white-space:nowrap;max-width:160px;text-overflow:ellipsis;overflow:hidden
}
.ball.appear{animation:pop .25s ease}
@keyframes pop{0%{transform:scale(.6);opacity:.3}100%{transform:scale(1);opacity:1}}

/* === Modales === */
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(99,102,241,.08);padding:16px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal.show{display:flex}
.modal .box{background:#fff;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.15);padding:20px;max-width:640px;width:100%}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modal-header h3{margin:0;font-size:1.1rem}
.modal-body{display:grid;gap:10px}
input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:.95rem}
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:780px){
  .row.cols-2,.row.cols-3{grid-template-columns:1fr}
  .board{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:18px}
  .ball{width:140px;height:140px}
  .ball .label{font-size:.95rem}
}
.small{font-size:.9rem;color:var(--muted)}
.list{display:grid;gap:10px;max-height:300px;overflow:auto;margin-top:8px}
.entry{background:#eef2ff;border-left:4px solid var(--primary);padding:8px;border-radius:10px}
.entry span{display:block;font-size:.85rem}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;background:#e5e7eb;color:#111827;margin-left:4px}
</style>
</head>
<body>
  <header>
    <h1>Agenda Pelotas</h1>
    <div class="status connecting" id="status">üïì Cargando datos locales...</div>
    <div>
      <button class="btn" id="btnAdd">+ Agregar actividad</button>
      <button class="btn gray" id="btnGlobal">Historial global</button>
    </div>
  </header>

  <section class="section">
    <h2>Recurrentes</h2>
    <div class="board" id="boardRecurrentes"></div>
  </section>

  <section class="section">
    <h2>One Time</h2>
    <div class="board" id="boardOneTime"></div>
  </section>

  <section class="section">
    <h2>L√≠mites / Metas</h2>
    <div class="board" id="boardLimit"></div>
  </section>

  <!-- === Modal Actividad (crear / editar) === -->
  <div class="modal" id="taskModal">
    <div class="box">
      <div class="modal-header">
        <h3 id="taskModalTitle">Nueva actividad</h3>
        <button class="btn gray" id="taskClose">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Nombre</label>
            <input type="text" id="taskName" placeholder="Ej: Gym, Estudiar GRE, etc." />
          </div>
        </div>
        <div class="row cols-2">
          <div>
            <label>Tipo</label>
            <select id="taskKind">
              <option value="recurrent">Recurrente</option>
              <option value="one_time">One Time</option>
              <option value="limit">L√≠mite / Meta</option>
            </select>
          </div>
          <div>
            <label>Meta (n√∫mero)</label>
            <input type="number" id="taskGoal" min="0" step="1" placeholder="Ej: 60 (minutos), 10 (veces)..." />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Unidad</label>
            <input type="text" id="taskUnit" placeholder="Ej: min, veces, p√°ginas..." />
          </div>
        </div>
        <div class="row">
          <small class="small">
            Recurrente / One Time: el progreso se calcula con lo que registres en el d√≠a.<br>
            L√≠mite / Meta: el progreso es acumulado (suma de todos los registros).
          </small>
        </div>
        <div class="row" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn gray" id="taskDelete" style="display:none">Eliminar</button>
          <button class="btn" id="taskSave">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === Modal Registro de actividad (hoy u otra fecha) === -->
  <div class="modal" id="entryModal">
    <div class="box">
      <div class="modal-header">
        <h3 id="entryTitle">Registrar progreso</h3>
        <button class="btn gray" id="entryClose">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="row cols-2">
          <div>
            <label>Fecha</label>
            <input type="date" id="entryDate" />
          </div>
          <div>
            <label>Cantidad</label>
            <input type="number" id="entryAmount" step="1" min="0" />
          </div>
        </div>
        <div class="row">
          <small class="small" id="entryHint"></small>
        </div>
        <div class="row" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="entrySave">Guardar registro</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === Modal Historial por actividad === -->
  <div class="modal" id="historyModal">
    <div class="box">
      <div class="modal-header">
        <h3 id="historyTitle">Historial</h3>
        <button class="btn gray" id="historyClose">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="card">
            <canvas id="historyChart" height="160"></canvas>
          </div>
        </div>
        <div class="row">
          <div class="list" id="historyList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- === Modal Historial Global === -->
  <div class="modal" id="globalModal">
    <div class="box">
      <div class="modal-header">
        <h3>Historial global</h3>
        <button class="btn gray" id="globalClose">Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="list" id="globalList"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ==================== ESTADO LOCAL ==================== */
const STORAGE_KEY = 'agendaPelotas_state_v1';
const $ = (sel) => document.querySelector(sel);

let state = {
  tasks: [],
  entries: [] // {id, taskId, date: 'YYYY-MM-DD', amount: number}
};
let tasks = []; // alias para comodidad
let currentTaskId = null;
let historyChart = null;

/* ==================== UTILIDADES ==================== */
function todayStr() {
  const d = new Date();
  return d.toISOString().slice(0,10);
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      state = JSON.parse(raw);
      state.tasks ??= [];
      state.entries ??= [];
    }
  } catch (e) {
    console.error('Error leyendo localStorage', e);
    state = { tasks: [], entries: [] };
  }
  tasks = state.tasks;
}

function saveState() {
  state.tasks = tasks;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ==================== PROGRESO ==================== */
function getEntriesForTask(taskId) {
  return state.entries.filter(e => e.taskId === taskId);
}

function progressNumbers(task) {
  const all = getEntriesForTask(task.id);
  const goal = Number(task.goal) || 0;
  if (goal <= 0) return { used: 0, goal: 0 };

  let used = 0;
  if (task.kind === 'limit') {
    // Meta acumulada
    used = all.reduce((s,e) => s + Number(e.amount || 0), 0);
  } else {
    // Recurrente / One Time: solo d√≠a seleccionado = hoy
    const today = todayStr();
    used = all
      .filter(e => e.date === today)
      .reduce((s,e) => s + Number(e.amount || 0), 0);
  }
  return { used, goal };
}

function computeProgress(task) {
  const { used, goal } = progressNumbers(task);
  if (!goal) return 0;
  return Math.max(0, Math.min(1, used / goal));
}

function fractionForTask(task) {
  const { used, goal } = progressNumbers(task);
  if (!goal) return { fracText: `${used.toFixed(0)}` };
  return { fracText: `${used.toFixed(0)}/${goal.toFixed(0)}` };
}

function colorForProgress(p) {
  if (p >= 1) return '#10b981';         // verde
  if (p >= 0.67) return '#3b82f6';      // azul
  if (p >= 0.34) return '#facc15';      // amarillo
  return '#ef4444';                     // rojo
}

/* ==================== MODALES ==================== */
function openModal(el) {
  el.classList.add('show');
}
function closeModal(el) {
  el.classList.remove('show');
}

/* ==================== RENDER DEL TABLERO ==================== */
function renderBoard() {
  const r = $("#boardRecurrentes"),
        o = $("#boardOneTime"),
        l = $("#boardLimit");
  r.innerHTML = o.innerHTML = l.innerHTML = '';

  tasks.forEach(t => {
    const p = computeProgress(t);
    const { fracText } = fractionForTask(t);
    const ball = document.createElement('div');
    ball.className = 'ball appear';
    ball.style.setProperty('--p', (p*100).toFixed(2)+'%');
    ball.style.setProperty('--col', colorForProgress(p));
    ball.title = t.name;
    ball.innerHTML = `
      <div class="center">
        <div class="frac">${fracText}</div>
        <div class="pct">${Math.round(p*100)}%</div>
      </div>
      <div class="label"><b>${t.name}</b></div>
    `;

    // Click ‚Üí registrar
    ball.addEventListener('click', () => openEntry(t.id));

    // Click derecho / long press ‚Üí historial
    ball.addEventListener('contextmenu', e => {
      e.preventDefault();
      openHistory(t.id);
    });
    let touchTimer;
    ball.addEventListener('touchstart', () => {
      touchTimer = setTimeout(() => openHistory(t.id), 600);
    });
    ball.addEventListener('touchend', () => clearTimeout(touchTimer));

    const type = t.kind || t.type;
    if (type === 'recurrent')      r.appendChild(ball);
    else if (type === 'one_time')  o.appendChild(ball);
    else                           l.appendChild(ball);
  });
}

/* ==================== ACTIVIDADES ==================== */
function openTaskModal(taskId = null) {
  currentTaskId = taskId;
  const modal = $('#taskModal');
  const title = $('#taskModalTitle');
  const btnDelete = $('#taskDelete');
  const nameInput = $('#taskName');
  const kindSelect = $('#taskKind');
  const goalInput = $('#taskGoal');
  const unitInput = $('#taskUnit');

  if (taskId) {
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;
    title.textContent = 'Editar actividad';
    nameInput.value = t.name || '';
    kindSelect.value = t.kind || 'recurrent';
    goalInput.value = t.goal ?? '';
    unitInput.value = t.unit || '';
    btnDelete.style.display = 'inline-block';
  } else {
    title.textContent = 'Nueva actividad';
    nameInput.value = '';
    kindSelect.value = 'recurrent';
    goalInput.value = '';
    unitInput.value = '';
    btnDelete.style.display = 'none';
  }

  openModal(modal);
}

function saveTaskFromModal() {
  const name = $('#taskName').value.trim();
  const kind = $('#taskKind').value;
  const goal = Number($('#taskGoal').value || 0);
  const unit = $('#taskUnit').value.trim();

  if (!name) {
    alert('Ponle un nombre a la actividad');
    return;
  }

  if (currentTaskId) {
    const idx = tasks.findIndex(t => t.id === currentTaskId);
    if (idx !== -1) {
      tasks[idx] = { ...tasks[idx], name, kind, goal, unit };
    }
  } else {
    const id = crypto.randomUUID();
    tasks.push({ id, name, kind, goal, unit });
  }

  saveState();
  renderBoard();
  closeModal($('#taskModal'));
}

function deleteCurrentTask() {
  if (!currentTaskId) return;
  if (!confirm('¬øEliminar esta actividad y sus registros?')) return;
  tasks = tasks.filter(t => t.id !== currentTaskId);
  state.entries = state.entries.filter(e => e.taskId !== currentTaskId);
  currentTaskId = null;
  saveState();
  renderBoard();
  closeModal($('#taskModal'));
}

/* ==================== REGISTRO DE PROGRESO ==================== */
function openEntry(taskId) {
  currentTaskId = taskId;
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  const modal = $('#entryModal');

  $('#entryTitle').textContent = `Registrar: ${task.name}`;
  $('#entryDate').value = todayStr();
  $('#entryAmount').value = '';

  const { used, goal } = progressNumbers(task);
  const unit = task.unit || '';
  let hint = '';
  if (goal > 0) {
    if (task.kind === 'limit') {
      hint = `Meta acumulada: ${used.toFixed(0)} / ${goal.toFixed(0)} ${unit}`;
    } else {
      hint = `Meta diaria: ${used.toFixed(0)} / ${goal.toFixed(0)} ${unit} (hoy)`;
    }
  } else {
    hint = `Sin meta num√©rica definida.`;
  }
  $('#entryHint').textContent = hint;

  openModal(modal);
}

function saveEntryFromModal() {
  if (!currentTaskId) return;
  const task = tasks.find(t => t.id === currentTaskId);
  if (!task) return;

  const date = $('#entryDate').value || todayStr();
  const amount = Number($('#entryAmount').value || 0);
  if (!amount) {
    alert('Ingresa una cantidad mayor a 0');
    return;
  }

  state.entries.push({
    id: crypto.randomUUID(),
    taskId: task.id,
    date,
    amount
  });

  saveState();
  renderBoard();
  closeModal($('#entryModal'));
}

/* ==================== HISTORIAL POR ACTIVIDAD ==================== */
function openHistory(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  const modal = $('#historyModal');
  $('#historyTitle').textContent = `Historial: ${task.name}`;

  const entries = getEntriesForTask(taskId)
    .slice()
    .sort((a,b) => a.date.localeCompare(b.date));

  const list = $('#historyList');
  list.innerHTML = '';
  if (entries.length === 0) {
    const div = document.createElement('div');
    div.className = 'entry';
    div.innerHTML = '<span>No hay registros a√∫n.</span>';
    list.appendChild(div);
  } else {
    entries.forEach(e => {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `
        <span><b>${e.date}</b> ‚Äî +${e.amount} ${task.unit || ''}</span>
      `;
      list.appendChild(div);
    });
  }

  // Chart
  const ctx = document.getElementById('historyChart').getContext('2d');
  if (historyChart) {
    historyChart.destroy();
  }
  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: entries.map(e => e.date),
      datasets: [{
        label: task.unit ? `Cantidad (${task.unit})` : 'Cantidad',
        data: entries.map(e => e.amount),
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { display: true },
        y: { display: true, beginAtZero: true }
      }
    }
  });

  openModal(modal);
}

/* ==================== HISTORIAL GLOBAL ==================== */
function openGlobalHistory() {
  const list = $('#globalList');
  list.innerHTML = '';

  const entries = state.entries
    .slice()
    .sort((a,b) => b.date.localeCompare(a.date)) // m√°s recientes primero
    .slice(0, 100); // l√≠mite por si acaso

  if (entries.length === 0) {
    const div = document.createElement('div');
    div.className = 'entry';
    div.innerHTML = '<span>No hay registros todav√≠a.</span>';
    list.appendChild(div);
  } else {
    entries.forEach(e => {
      const task = tasks.find(t => t.id === e.taskId);
      const name = task ? task.name : 'Actividad desconocida';
      const unit = task?.unit || '';
      const kind = task?.kind || '';
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `
        <span><b>${e.date}</b> ‚Äî ${name}</span>
        <span>+${e.amount} ${unit} <span class="badge">${kind}</span></span>
      `;
      list.appendChild(div);
    });
  }

  openModal($('#globalModal'));
}

/* ==================== INICIALIZACI√ìN ==================== */
document.addEventListener('DOMContentLoaded', () => {
  // Estado
  loadState();
  renderBoard();

  const status = $('#status');
  status.classList.remove('connecting');
  status.classList.add('connected');
  status.textContent = 'üíæ Datos guardados en este dispositivo';

  // Botones header
  $('#btnAdd').addEventListener('click', () => openTaskModal(null));
  $('#btnGlobal').addEventListener('click', openGlobalHistory);

  // Modal actividad
  $('#taskClose').addEventListener('click', () => closeModal($('#taskModal')));
  $('#taskSave').addEventListener('click', saveTaskFromModal);
  $('#taskDelete').addEventListener('click', deleteCurrentTask);

  // Modal registro
  $('#entryClose').addEventListener('click', () => closeModal($('#entryModal')));
  $('#entrySave').addEventListener('click', saveEntryFromModal);

  // Modal historial
  $('#historyClose').addEventListener('click', () => closeModal($('#historyModal')));

  // Modal global
  $('#globalClose').addEventListener('click', () => closeModal($('#globalModal')));
});
</script>
</body>
</html>
