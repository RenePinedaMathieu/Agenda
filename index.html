<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Agenda Interactiva</title>
<style>
  :root {
    --primary: #6366f1;
    --secondary: #a5b4fc;
    --background: #f5f7ff;
    --text: #1f2937;
    --muted: #6b7280;
    --danger: #ef4444;
    --ok: #10b981;
    --warn: #f59e0b;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: "Inter", "Segoe UI", sans-serif;
    background: var(--background);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 12px 64px;
  }

  h1 {
    font-size: 1.8rem;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 14px;
    font-weight: 800;
  }

  .topbar {
    width: 100%;
    max-width: 760px;
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    align-items: center;
    justify-content: space-between;
  }

  .topbar .spacer { flex: 1; }

  .btn {
    padding: 10px 14px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: transform .15s ease, opacity .2s ease;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn:active { transform: translateY(0); opacity: .9; }
  .btn.gray { background: #9ca3af; }

  .wrap {
    width: 100%;
    max-width: 760px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .card {
    background: white;
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 6px 18px rgba(99,102,241,.08);
    transition: transform .15s ease;
  }
  .card:hover { transform: translateY(-2px); }

  .task-header {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
    align-items: center;
    cursor: pointer;
  }
  .task-title { font-weight: 700; }
  .task-meta { font-size: .85rem; color: var(--muted); }

  .progress {
    margin-top: 8px;
    background: #eef2ff;
    border-radius: 10px;
    height: 10px;
    overflow: hidden;
  }
  .bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    width: 0%;
    transition: width .3s ease;
  }
  .progress-label {
    margin-top: 6px;
    font-size: .9rem;
    color: var(--muted);
  }

  .entry-inline {
    margin-top: 12px;
    display: grid;
    grid-template-columns: 1fr 120px auto;
    gap: 8px;
  }
  .entry-inline.money { grid-template-columns: 1fr 120px 120px auto; }

  input[type="text"], input[type="number"], select, textarea {
    padding: 10px;
    border: 1px solid #c7d2fe;
    border-radius: 10px;
    outline: none;
    font-size: .95rem;
    background: #fff;
  }
  input[type="number"] { -moz-appearance: textfield; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

  /* Modal */
  .modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.6);
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(3px);
    padding: 16px;
  }
  .modal .box {
    background: white; width: 100%; max-width: 520px;
    border-radius: 18px; padding: 18px;
    box-shadow: 0 12px 28px rgba(0,0,0,.15);
    animation: pop .15s ease;
  }
  @keyframes pop { from{ transform: scale(.97); opacity: 0; } to{ transform: scale(1); opacity: 1; } }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .row + .row { margin-top: 10px; }
  .mt { margin-top: 12px; }

  /* Entries panel */
  #entriesPanel { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(3px); }
  #entriesBox { background: white; width: 100%; max-width: 560px; border-radius: 18px; padding: 18px; box-shadow: 0 12px 28px rgba(0,0,0,.15); }
  #entriesBox h2 { margin: 0 0 8px; color: var(--primary); }
  .entry {
    background: #eef2ff;
    padding: 10px;
    border-radius: 10px;
    margin: 8px 0;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
    align-items: start;
  }
  .entry small { color: var(--muted); display: block; }
  .entry .del { background: var(--danger); padding: 8px 10px; border-radius: 10px; color: #fff; border: none; cursor: pointer; }

  .panel-buttons { display: flex; gap: 8px; justify-content: space-between; margin-top: 10px; }
  .btn.danger { background: var(--danger); }
  .hint { font-size: .85rem; color: var(--muted); }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: .75rem; font-weight: 700;
    background: #eef2ff; color: var(--primary);
    margin-left: 8px;
  }
  .badge.warn { background: #fff7ed; color: var(--warn); }
  .badge.ok { background: #ecfdf5; color: var(--ok); }
</style>
</head>
<body>
  <h1>üìÖ Agenda Interactiva</h1>

  <div class="topbar">
    <div class="spacer"></div>
    <button class="btn" id="btnNew">Nueva tarea</button>
  </div>

  <div id="list" class="wrap"></div>

  <!-- MODAL Nueva Tarea -->
  <div id="modalNew" class="modal">
    <div class="box">
      <h3 style="margin:0 0 8px;">Crear nueva tarea</h3>
      <label>Nombre</label>
      <input id="newName" type="text" placeholder="Ej: Entrenar / Leer 30 min" />

      <div class="row mt">
        <div>
          <label>Tipo</label>
          <select id="newType">
            <option value="reminder">Recordatorio</option>
            <option value="count">Objetivo / L√≠mite de ENTRADAS</option>
            <option value="money">Objetivo / L√≠mite de DINERO</option>
          </select>
        </div>
        <div>
          <label>Periodo</label>
          <select id="newPeriod">
            <option value="daily">Diario</option>
            <option value="weekly" selected>Semanal</option>
            <option value="monthly">Mensual</option>
          </select>
        </div>
      </div>

      <div class="row mt" id="limitRow">
        <div>
          <label id="limitLabel">L√≠mite (cantidad)</label>
          <input id="newLimit" type="number" min="0" step="1" placeholder="Ej: 5" />
        </div>
        <div>
          <label class="hint" id="limitHint">Para ‚Äúdinero‚Äù, el l√≠mite es en n√∫meros (ej: 50000).</label>
        </div>
      </div>

      <div class="panel-buttons mt">
        <button class="btn gray" id="cancelNew">Cancelar</button>
        <button class="btn" id="createNew">Crear</button>
      </div>
    </div>
  </div>

  <!-- PANEL de Entradas -->
  <div id="entriesPanel">
    <div id="entriesBox">
      <h2 id="entryTitle"></h2>
      <div id="entriesMeta" class="hint"></div>
      <div id="entriesContainer" style="margin-top:8px;"></div>

      <div class="panel-buttons">
        <button class="btn danger" onclick="confirmDeleteTask()">Eliminar tarea</button>
        <button class="btn gray" onclick="closeEntries()">Cerrar</button>
      </div>
    </div>
  </div>

<script>
/* ====================== Estado ====================== */
let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
let selectedTask = null;

const $ = (q) => document.querySelector(q);
const list = $("#list");

/* ====================== Utilidades de fechas ====================== */
function startOfDay(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}
function startOfWeek(d) { // Lunes como inicio
  const x = new Date(d);
  const day = (x.getDay() + 6) % 7; // 0 = lunes
  x.setHours(0,0,0,0);
  x.setDate(x.getDate() - day);
  return x;
}
function startOfMonth(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  x.setDate(1);
  return x;
}
function inPeriod(dateStr, period) {
  const now = new Date();
  const t = new Date(dateStr);
  const s =
    period === "daily" ? startOfDay(now) :
    period === "weekly" ? startOfWeek(now) :
    startOfMonth(now);
  return t >= s;
}

/* ====================== Persistencia ====================== */
function save() {
  localStorage.setItem("tasks", JSON.stringify(tasks));
}

/* ====================== UI: Render principal ====================== */
function render() {
  list.innerHTML = "";
  tasks.forEach((t, i) => {
    const card = document.createElement("div");
    card.className = "card";

    // Header clickeable para abrir panel
    const header = document.createElement("div");
    header.className = "task-header";
    header.onclick = (e)=>{ if (e.target.closest('.entry-inline')) return; openEntries(i); };

    const title = document.createElement("div");
    title.className = "task-title";
    title.textContent = t.name;

    const meta = document.createElement("div");
    meta.className = "task-meta";
    meta.innerHTML = getTaskMetaText(t);

    const right = document.createElement("div");
    right.innerHTML = badgeForTask(t);

    header.appendChild(title);
    header.appendChild(right);

    card.appendChild(header);
    card.appendChild(meta);

    // Progreso (si aplica)
    const prog = progressForTask(t);
    if (prog) {
      const progress = document.createElement("div");
      progress.className = "progress";
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.width = Math.min(100, Math.round(prog.pct)) + "%";
      progress.appendChild(bar);
      const label = document.createElement("div");
      label.className = "progress-label";
      label.textContent = prog.label;
      card.appendChild(progress);
      card.appendChild(label);
    }

    // Entrada inline
    const inline = document.createElement("div");
    inline.className = "entry-inline" + (t.type === "money" ? " money" : "");
    inline.onclick = (e)=>e.stopPropagation();

    const comment = document.createElement("input");
    comment.type = "text";
    comment.placeholder = "Agregar entrada...";
    comment.id = `cmt-${i}`;

    let amountInput = null;
    if (t.type === "money") {
      amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.min = "0";
      amountInput.step = "0.01";
      amountInput.placeholder = "Monto ($)";
      amountInput.id = `amt-${i}`;
      inline.appendChild(comment);
      inline.appendChild(amountInput);
    } else {
      inline.appendChild(comment);
    }

    // Period quick-view
    const periodView = document.createElement("input");
    periodView.type = "text";
    periodView.value = periodLabel(t.period);
    periodView.disabled = true;
    periodView.style.textAlign = "center";

    const addBtn = document.createElement("button");
    addBtn.className = "btn";
    addBtn.textContent = "+";
    addBtn.onclick = ()=> addEntryInline(i);

    if (t.type === "money") {
      inline.appendChild(periodView);
      inline.appendChild(addBtn);
    } else {
      inline.appendChild(addBtn);
    }

    card.appendChild(inline);
    list.appendChild(card);
  });
}

function periodLabel(p) {
  return p === "daily" ? "Diario" : p === "weekly" ? "Semanal" : "Mensual";
}
function getTaskMetaText(t) {
  if (t.type === "reminder") return "Recordatorio";
  if (t.type === "count")   return `Objetivo/L√≠mite de ENTRADAS ‚Ä¢ ${periodLabel(t.period)} ‚Ä¢ L√≠mite: ${t.limit ?? "-"}`
  if (t.type === "money")   return `Objetivo/L√≠mite de DINERO ‚Ä¢ ${periodLabel(t.period)} ‚Ä¢ L√≠mite: $${(t.limit ?? 0).toLocaleString()}`;
  return "";
}
function badgeForTask(t) {
  const prog = progressForTask(t);
  if (!prog) return `<span class="badge">Sin objetivo</span>`;
  let cls = "badge";
  if (prog.state === "ok") cls += " ok";
  if (prog.state === "warn") cls += " warn";
  return `<span class="${cls}">${prog.badge}</span>`;
}

/* ====================== Progreso ====================== */
function progressForTask(t) {
  const entries = t.entries || [];
  const nowEntries = t.period ? entries.filter(e => inPeriod(e.date, t.period)) : entries;

  if (t.type === "count") {
    const used = nowEntries.length;
    const limit = Number(t.limit || 0);
    if (!limit) return { pct: 0, label: `${used} entradas`, badge: `${used} / ‚Äî`, state: "ok" };
    const pct = (used / limit) * 100;
    const state = used <= limit ? "ok" : "warn";
    const rest = Math.max(0, limit - used);
    const label = `${used} / ${limit} entradas ‚Ä¢ Restan ${rest}`;
    return { pct, label, badge: `${used}/${limit}`, state };
  }
  if (t.type === "money") {
    const used = nowEntries.reduce((s, e) => s + (Number(e.amount) || 0), 0);
    const limit = Number(t.limit || 0);
    if (!limit) return { pct: 0, label: `$${used.toLocaleString()} usados`, badge: `$${used.toLocaleString()} / ‚Äî`, state: "ok" };
    const pct = (used / limit) * 100;
    const state = used <= limit ? "ok" : "warn";
    const rest = Math.max(0, limit - used);
    const label = `$${used.toLocaleString()} / $${limit.toLocaleString()} ‚Ä¢ Quedan $${rest.toLocaleString()}`;
    return { pct, label, badge: `$${used.toLocaleString()}/$${limit.toLocaleString()}`, state };
  }
  // reminder
  return null;
}

/* ====================== Entradas ====================== */
function addEntryInline(i) {
  const t = tasks[i];
  const comment = document.getElementById(`cmt-${i}`).value.trim();
  if (t.type === "money") {
    const amtVal = document.getElementById(`amt-${i}`).value;
    const amount = Number(amtVal);
    if (isNaN(amount) || amount < 0) { alert("Ingresa un monto v√°lido (>= 0)."); return; }
    pushEntry(t, { text: comment || "(sin comentario)", amount, date: new Date().toISOString() });
    document.getElementById(`amt-${i}`).value = "";
  } else {
    if (!comment) { alert("Escribe un comentario para la entrada."); return; }
    pushEntry(t, { text: comment, date: new Date().toISOString() });
  }
  document.getElementById(`cmt-${i}`).value = "";
  save();
  render();
}

function pushEntry(task, entry) {
  if (!task.entries) task.entries = [];
  task.entries.push(entry);
}

/* ====================== Panel Entradas ====================== */
function openEntries(i) {
  selectedTask = i;
  const t = tasks[i];
  $("#entryTitle").textContent = t.name;
  $("#entriesMeta").textContent = getTaskMetaText(t);
  renderEntriesList();
  $("#entriesPanel").style.display = "flex";
}
function renderEntriesList() {
  const t = tasks[selectedTask];
  const cont = $("#entriesContainer");
  cont.innerHTML = "";
  const entries = (t.entries || []).slice().reverse(); // m√°s recientes arriba

  if (entries.length === 0) {
    cont.innerHTML = `<p class="hint" style="text-align:center;">Sin entradas a√∫n.</p>`;
    return;
  }

  entries.forEach((e, idxFromEnd) => {
    const realIndex = (t.entries.length - 1) - idxFromEnd; // √≠ndice en arreglo original
    const div = document.createElement("div");
    div.className = "entry";
    const left = document.createElement("div");
    const date = new Date(e.date);
    const dateText = isNaN(date) ? e.date : date.toLocaleString();
    left.innerHTML = `<b>${dateText}</b><small>${e.text || ""}</small>${t.type === "money" ? `<small><b>Monto:</b> $${Number(e.amount||0).toLocaleString()}</small>` : ""}`;
    const del = document.createElement("button");
    del.className = "del";
    del.textContent = "Eliminar";
    del.onclick = ()=> deleteEntry(realIndex);
    div.appendChild(left);
    div.appendChild(del);
    cont.appendChild(div);
  });
}
function closeEntries() {
  $("#entriesPanel").style.display = "none";
  selectedTask = null;
  render(); // refrescar barras/progreso
}
function deleteEntry(index) {
  if (!confirm("¬øEliminar esta entrada?")) return;
  const t = tasks[selectedTask];
  t.entries.splice(index, 1);
  save();
  renderEntriesList();
}

/* ====================== Eliminar tarea ====================== */
function confirmDeleteTask() {
  if (selectedTask == null) return;
  const t = tasks[selectedTask];
  if (confirm(`¬øEliminar la tarea "${t.name}" y todas sus entradas?`)) {
    tasks.splice(selectedTask, 1);
    save();
    closeEntries();
  }
}

/* ====================== Nueva tarea (modal) ====================== */
$("#btnNew").onclick = ()=> openNew();
$("#cancelNew").onclick = ()=> closeNew();
$("#createNew").onclick = ()=> createNew();
$("#newType").onchange = handleTypeChange;

function openNew() {
  $("#newName").value = "";
  $("#newType").value = "reminder";
  $("#newPeriod").value = "weekly";
  $("#newLimit").value = "";
  handleTypeChange();
  $("#modalNew").style.display = "flex";
}
function closeNew() {
  $("#modalNew").style.display = "none";
}
function handleTypeChange() {
  const type = $("#newType").value;
  const limitRow = $("#limitRow");
  if (type === "reminder") {
    limitRow.style.display = "none";
  } else {
    limitRow.style.display = "grid";
    $("#limitLabel").textContent = type === "money" ? "L√≠mite de DINERO" : "L√≠mite de ENTRADAS";
    $("#limitHint").textContent = type === "money"
      ? "Ingresa el tope de dinero para el per√≠odo (ej: 50000)."
      : "Cantidad m√°xima de entradas permitidas en el per√≠odo.";
  }
}
function createNew() {
  const name = $("#newName").value.trim();
  const type = $("#newType").value;        // reminder | count | money
  const period = $("#newPeriod").value;    // daily | weekly | monthly
  const limitVal = $("#newLimit").value.trim();

  if (!name) { alert("Escribe un nombre para la tarea."); return; }

  let limit = null;
  if (type !== "reminder") {
    if (limitVal === "" || isNaN(Number(limitVal)) || Number(limitVal) < 0) {
      alert("Ingresa un l√≠mite v√°lido (>= 0).");
      return;
    }
    limit = Number(limitVal);
  }

  const task = {
    name,
    type,
    period: type === "reminder" ? null : period,
    limit: type === "reminder" ? null : limit,
    entries: []
  };

  tasks.push(task);
  save();
  closeNew();
  render();
}

/* ====================== Inicializar ====================== */
render();
</script>
</body>
</html>
